@Component
@Path("/dcbUpgrade")
public class DcbUpgradeController {
	@Context
	private HttpServletRequest req;

	@Autowired
	private SSOSupportService ssoService;

	@Autowired
	private DCBService dcbService;

	// 取得使用者DCB升級初始狀態
	@POST
	@Path("/queryUpgradeInfo")
	@Produces({ APPLICATION_JSON + "; charset=UTF-8" })
	public Map<String, Object> getDcbUpgradeInfo() {
		// SSO 使用者登入資訊
		UserProfileBean userProfile = ssoService.getProfile(req);
		String msisdn = userProfile.getMsisdn();
		String contractId = userProfile.getContractId();

		Map<String, Object> dcbUpgradeInfo = dcbService.getDcbUpgradeInfo(msisdn, contractId);
		String resultCode = (String) dcbUpgradeInfo.get("ResultCode");
		String message = "系統忙碌，請稍後再試，謝謝。";
		Map<String, Object> resultData = new HashMap<>();
		resultData.put("resultCode", resultCode);

		if (resultCode.equals("00000")) {
			message = (String) dcbUpgradeInfo.get("Message");
		}
		if (resultCode.equals("20000")) {
			message = "用戶資訊異常，無須進行升階，謝謝。";
		}
		if (resultCode.equals("20001")) {
			message = "已升階完成，無須再進行升階，謝謝。";
		}
		if (resultCode.equals("20002")) {
			message = "升階資訊過期，無須進行升階，謝謝。";
		}
		resultData.put("message", message);
		return resultData;
	}

	// 取得使用者DCB升級初始狀態
	@POST
	@Path("/submitUpgrade")
	@Produces({ APPLICATION_JSON + "; charset=UTF-8" })
	public Map<String, Object> submitDcbUpgrade() {
		// SSO 使用者登入資訊
		UserProfileBean userProfile = ssoService.getProfile(req);
		String msisdn = userProfile.getMsisdn();
		String contractId = userProfile.getContractId();

		Map<String, Object> dcbUpgradeResult = dcbService.setDcbUpgrade(msisdn, contractId);
		String resultCode = (String) dcbUpgradeResult.get("ResultCode");
		Map<String, Object> resultData = new HashMap<>();
		resultData.put("resultCode", resultCode);
		String message = "系統忙碌，請稍後再試，謝謝。";
		String title = "設定失敗";
		if (resultCode.equals("00000")) {
			title = "設定完成";
			message = "您已完成本次額度調整，謝謝。";
		}
		
		resultData.put("title", title);
		resultData.put("message", message);
		return resultData;
	}
}
